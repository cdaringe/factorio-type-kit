<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="height=device-height, width=device-width, initial-scale=1"/><link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png"/><link rel="manifest" href="/favicon/site.webmanifest"/><meta name="theme-color" content="#000"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><meta name="description" content="factorio-type-kit - author factorio mods in typescript, or generate interfaces for your language of choice"/><title>Get started modding Factorio in TypeScript | factorio-type-kit</title><meta name="next-head-count" content="10"/><link rel="preload" href="/factorio-type-kit/_next/static/css/7fe093da7844c34a6a36.css" as="style"/><link rel="stylesheet" href="/factorio-type-kit/_next/static/css/7fe093da7844c34a6a36.css" data-n-g=""/><link rel="preload" href="/factorio-type-kit/_next/static/css/a668ece60a533cfb4fce.css" as="style"/><link rel="stylesheet" href="/factorio-type-kit/_next/static/css/a668ece60a533cfb4fce.css" data-n-p=""/><noscript data-n-css=""></noscript><link rel="preload" href="/factorio-type-kit/_next/static/chunks/main-ae4733327bd95c4ac325.js" as="script"/><link rel="preload" href="/factorio-type-kit/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" as="script"/><link rel="preload" href="/factorio-type-kit/_next/static/chunks/framework.9d524150d48315f49e80.js" as="script"/><link rel="preload" href="/factorio-type-kit/_next/static/chunks/commons.9852770279c0c14d4cef.js" as="script"/><link rel="preload" href="/factorio-type-kit/_next/static/chunks/pages/_app-3b43a8403cdc10895abd.js" as="script"/><link rel="preload" href="/factorio-type-kit/_next/static/chunks/2c3b9bffc7150b37a7b3810dfcf1c0b0fac2bd18.c4172b38757f6e9df0dd.js" as="script"/><link rel="preload" href="/factorio-type-kit/_next/static/chunks/pages/posts/%5Bslug%5D-a955a00b7703730922ad.js" as="script"/></head><body><div id="__next"><div class="min-h-screen"><div class="border-b bg-accent-1 border-accent-2"><div class="container mx-auto px-5"><div class="py-2 text-center text-sm">The source code for this project is<!-- --> <a href="https://github.com/cdaringe/factorio-type-kit" class="underline hover:text-success duration-200 transition-colors">available on GitHub</a>.</div></div></div><main><div class="container mx-auto px-5"><h2 class="text-2xl md:text-4xl font-bold tracking-tight md:tracking-tighter leading-tight mb-20 mt-8"><a class="hover:underline" href="/factorio-type-kit">‚Üê ftk</a>.</h2><article class="mb-32"><h1 class="text-6xl md:text-7xl lg:text-8xl font-bold tracking-tighter leading-tight md:leading-none mb-12 text-center md:text-left">Get started modding Factorio in TypeScript</h1><div class="hidden md:block md:mb-12"><div class="flex items-center"><img src="/factorio-type-kit/assets/blog/authors/cdaringe.jpeg" class="w-12 h-12 rounded-full mr-4" alt="cdaringe"/><div class="text-xl font-bold">cdaringe</div></div></div><div class="max-w-2xl mx-auto"><div class="block md:hidden mb-6"><div class="flex items-center"><img src="/factorio-type-kit/assets/blog/authors/cdaringe.jpeg" class="w-12 h-12 rounded-full mr-4" alt="cdaringe"/><div class="text-xl font-bold">cdaringe</div></div></div><div class="mb-6 text-lg"><time dateTime="2021-01-24T05:35:07.322Z">January	24, 2021</time></div></div><div class="max-w-2xl mx-auto"><div class="markdown-styles_markdown__1x9gM"><p><strong>Of course</strong> we want type safety when programming Factorio mods. Unfortunately, Factorio's Lua modding API offers no such provisions. Good news! <a href="https://github.com/cdaringe/factorio-type-kit">factorio-type-kit</a> helps bridge that gap via TypeScript. While TypeScript doesn't offer
the strongest safety guarantees of any language under the sun, it does offer moderate safety, and works well
as a Lua replacement. The following steps are required to author factorio mods in TS:</p>
<h2>Factorio in TypeScript - Outline</h2>
<p>We will execute the following steps later, but at a glance, here are the general required steps:</p>
<ol>
<li>Install <a href="https://nodejs.org/">node</a>. I recommend using <a href="https://github.com/Schniz/fnm#using-a-script-macoslinux">fnm</a> for installing and managing nodejs installations.</li>
<li>(optional) Install <a href="https://classic.yarnpkg.com/en/docs/install">yarn</a>. <code>npm</code> is the default package manager for nodejs, but the following document uses <code>yarn</code>. It takes only moments to install.</li>
<li>Setup a <code>nodejs</code> project</li>
<li>Install <a href="https://github.com/cdaringe/factorio-type-kit">factorio-type-kit</a>, <a href="https://www.typescriptlang.org/#installation">typescript</a>, and <a href="https://github.com/TypeScriptToLua/TypeScriptToLua">TypeScriptToLua</a></li>
<li>Configure the typescript compiler to use TypeScriptToLua</li>
<li>Code</li>
<li>Package &#x26; deploy the mod</li>
</ol>
<p>It is assumed that the reader has installed node &#x26; yarn before proceeding further.</p>
<p>Let's get to work.</p>
<h2>Bootstrapping a barebones mod</h2>
<p>The following command can be run to bootstrap a fresh mod project <em>automatically</em>:</p>
<!-- <Shell children='$ yarn create factorio-mod <mod-name>' /> -->
<pre><code class="hljs language-shell"><span class="hljs-meta">$</span><span class="bash"> yarn create factorio-mod &#x3C;mod-name></span></code></pre>
<p>For demonstration purposes, I will create a mod called <code>vroom</code>. This mod will make the character accelerate as he runs, allowing the player to travel at warp speed!</p>
<pre><code class="hljs language-shell"><span class="hljs-meta">$</span><span class="bash"> yarn create factorio-mod vroom</span>
...
Victory! Your mod is ready to roll. Execute the following commands to get going:
  - cd "/Users/cdaringe/src/vroom"
  - yarn start
‚ú®  Done in 5.75s.</code></pre>
<p>This step automatically installs the aforementioned dependencies and sets up the compiler toolchain.
If you want to do these steps manually, please see the <a href="https://github.com/cdaringe/vroom">vroom</a> codebase, and replicate the artifacts hosted there. <a href="https://mods.factorio.com/mod/vroom">@mods.factorio.com</a></p>
<h2>Understanding the barebones mod</h2>
<p>Let us <code>cd "path/to/vroom"</code>, and study the content. If you
are familiar with the <a href="https://wiki.factorio.com/Tutorial:Mod_structure">factorio mod directory stucture</a>,
this should look quite familiar.</p>
<pre><code class="hljs language-shell">~/src/vroom via ‚¨¢ v15.0.1
‚ùØ ls -alh
Permissions Size User     Date Modified Name
.rw-r--r--   167 cdaringe 24 Jan 11:37  control.ts
.rw-r--r--   183 cdaringe 24 Jan 11:37  info.json
drwxr-xr-x     - cdaringe 24 Jan 11:37  node_modules
.rw-r--r--   247 cdaringe 24 Jan 11:37  package.json
.rw-r--r--   131 cdaringe 24 Jan 11:37  readme.md
.rw-r--r--   331 cdaringe 24 Jan 11:37  tsconfig.json
.rw-r--r--   35k cdaringe 24 Jan 11:37  yarn.lock</code></pre>
 <!-- `.trim()} /> -->
<ul>
<li><code>info.json</code> - the entrypont to all factorio mods, pre-populated with some essentials</li>
<li><code>control.ts</code> - this file will compile to <code>control.lua</code>, which Factorio uses to run your mod!</li>
<li><code>tsconfig.json</code> - typescript configuration, critically including <a href="https://typescripttolua.github.io/docs/configuration">TypescriptToLua configuration</a></li>
<li><code>package.json</code> &#x26; <code>node_modules</code> - resources to support your TS development experience :)</li>
</ul>
<p>Let's open up <code>control.ts</code>:</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">const</span> onTick = <span class="hljs-function">(<span class="hljs-params">_evt: OnTickPayload</span>) =></span> {
  game.print(serpent.block({
    <span class="hljs-attr">hello</span>: <span class="hljs-string">"world"</span>,
    <span class="hljs-attr">its_nice</span>: <span class="hljs-string">"to see you"</span>
  }));
};

script.on_event(defines.events.on_tick, onTick);</code></pre>
<ul>
<li><code>script.on_event</code> - typed</li>
<li><code>game</code> - typed</li>
<li><code>serpent</code> - typed</li>
<li><code>evt</code> - typed, via casting</li>
</ul>
<p>Boom! Types for everything!</p>
<p>...but not quite. The Factorio Lua documentation is <em>lossy</em>, and has many cases where we simply <em>cannot</em> parse correct type definitions from the Factorio website. Until the factorio development team publicly supports  machine-readable API documentation, <code>factorio-type-kit</code> TypeScript provisions will generally only be 70-80%+ complete. Thus, TypeScript users will be periodically disappointed to find <code>any</code> or <code>unknown</code> types in various interfaces. With that said, <code>factorio-type-kit</code> users are welcome to manually backfill essential definitions to make our community's development kit better.</p>
<h2>Starting the mod compiler</h2>
<pre><code class="hljs language-shell"><span class="hljs-meta">$</span><span class="bash"> yarn start</span></code></pre>
<p>Momentarily after launching the watching compiler, <code>control.lua</code> should be emitted. Open it up:</p>
<pre><code class="hljs language-lua">onTick = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_evt)</span></span>
    game.<span class="hljs-built_in">print</span>(
        serpent.block({hello = <span class="hljs-string">"world"</span>, its_nice = <span class="hljs-string">"to see you"</span>})
    )
<span class="hljs-keyword">end</span>
script.on_event(defines.events.on_tick, onTick)</code></pre>
<p>The TypeScriptToLua compiler does a fanstastic job on producing readable Lua.</p>
<h2>Implementing vroom</h2>
<p>The very first thing the <code>vroom</code> mod needs to do is detect when the player is in motion.</p>
<p>Rather that pull up the documentation, I'll just open up another call <code>script.on_event</code>, then
begin typing in <code>defines.events.</code>. After intellisense presents me options, I will select <code>on_player_changed_position</code>. The type definitions tell me a callback is also required. I will enter in <code>onPositionChanged</code>.</p>
<pre><code class="hljs language-typescript">script.on_event(
  defines.events.on_player_changed_position,
  onPositionChange
);</code></pre>
<p><code>onPositionChange</code> is not defined yet. Let's discuss what it needs to do then draft it.
First, it needs to get the player's current speed. Next, the speed needs to increase when running. Because the purpose of the mod is to accelerate the user, we multiply the previous speed by a scalar every so often.</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">const</span> onPositionChange = <span class="hljs-function">(<span class="hljs-params">evt: OnPlayerChangedPositionPayload</span>) =></span> {
  <span class="hljs-keyword">const</span> player = game.get_player(evt.player_index);
  <span class="hljs-keyword">if</span> (player.walking_state.walking) {
    <span class="hljs-comment">// ...</span>
  }
};</code></pre>
<p>Immediately take note that we have manually specified the type of <code>evt</code> as <code>OnPlayerChangedPositionPayload</code>. All factorio script event types follow the event naming convention: <code>&#x3C;CamelCased-EventName>Payload</code>. A future version may automatically apply types to the <code>on_event</code> callback, so you not need cast.</p>
<p>The first thing I noticed was that <code>evt</code> did not have a reference directly to the player I needed.
It does contain the <code>player_id</code> however, and with that ID we can call the <code>get_player</code> method on the global <code>game</code> instance. <code>get_player</code> returns an instance of a <code>LuaPlayer</code>, contains a <code>walking_state</code> property. Let's use <em>that</em>. We know that we <em>only</em> want to speed up the player if he is in motion, so let's further wrap our logic inside a conditional--<code>if (player.walking_state.walking) { ... }</code>.</p>
<p>Next up, how do we actually speed up the player? After searching the API documentation, I concluded that there was not a direct value specifying a velocity of the character. However, I did come across <code>character_running_speed_modifier</code>, which the type definitions told me is of type <code>number</code>. Unexpectedly, through trial and error, I learned that <code>character_running_speed_modifier</code> could be zero. <code>Speed * 0 = 0</code>, so Factorio likely does a 0 check internally before calculating the player's speed. We will have to do a similar check. Notice that typescript did not me help uncover my bug! Anything of type <code>number</code> can rightfully be zero, so shame on me! Defensive programmers everywhere are saying "you should have seen this coming", and they would be correct :). Equipped with this knowledge, let's fill in the rest.</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">const</span> onPositionChange = <span class="hljs-function">(<span class="hljs-params">evt: OnPlayerChangedPositionPayload</span>) =></span> {
  <span class="hljs-keyword">const</span> player = game.get_player(evt.player_index);
  <span class="hljs-keyword">if</span> (player.walking_state.walking) {
    <span class="hljs-keyword">const</span> lastSpeed = player.character_running_speed_modifier;
    <span class="hljs-keyword">const</span> baseSpeed = lastSpeed == <span class="hljs-number">0</span> ? <span class="hljs-number">1</span> : lastSpeed;
    player.character_running_speed_modifier = baseSpeed * <span class="hljs-number">1.01</span>;
  }
};</code></pre>
<p>When our player stops running, we want to restart the acceleration process for the next time he runs.
My original approach was to listen for <code>keyup</code> events. Alas, Factorio has no key events. How else could I determine if the player has stopped running, and thus safely reset the speed modifier? Easy! On every tick of the game, I can check all players for motion--and turn off the multiplier if they are stopped!</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">const</span> onTick = <span class="hljs-function">(<span class="hljs-params">_evt: OnTickPayload</span>) =></span> {
  <span class="hljs-built_in">Object</span>.entries(game.players).forEach(<span class="hljs-function">(<span class="hljs-params">[_id, player]</span>) =></span> {
    <span class="hljs-keyword">if</span> (
      player.character_running_speed_modifier > <span class="hljs-number">0</span> &#x26;&#x26;
      !player.walking_state.walking
    ) {
      player.character_running_speed_modifier = <span class="hljs-number">0</span>;
    }
  });
};</code></pre>
<p>That is, for every player, if there is a positive speed modifier and and the player is not walking, zero out the modifier.</p>
<p>Why didn't we just do a <code>game.players.forEach</code>? <code>game.players</code> isn't an array, so that won't work. TypeScript protected us from making that mistake! What about <code>Object.entries(game.players).forEach</code>? Yep, that worked! Why did we not do <code>Object.values(...)</code>? Because <code>game.players</code> is a <a href="https://lua-api.factorio.com/latest/LuaGameScript.html#LuaGameScript.players">special dictionary</a> in Lua. Not all iterables map cleanly between languages. <code>Object.values(...)</code> wouldn't have given us compiler error, but still would have failed. Improved typing is needed to protect against these failures. While TypeScriptToLua generally helps out a great deal protect us from writing erroneous code, it is only as good as its applied type constraints.</p>
<p>When using JS standard library provisions, as we did above, the compiler will add a typescript-lua polyfill, <code>lualib_bundle</code>. The emitted Lua perhaps is not as elegant:</p>
<pre><code class="hljs language-lua"><span class="hljs-built_in">require</span>(<span class="hljs-string">"lualib_bundle"</span>);
<span class="hljs-comment">-- ...</span>
onTick = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_evt)</span></span>
    __TS__ArrayForEach(
        __TS__ObjectEntries(game.players),
        <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(____, ____bindingPattern0)</span></span>
            <span class="hljs-keyword">local</span> _id = ____bindingPattern0[<span class="hljs-number">1</span>]
            <span class="hljs-keyword">local</span> player
            player = ____bindingPattern0[<span class="hljs-number">2</span>]
            <span class="hljs-keyword">if</span> (player.character_running_speed_modifier > <span class="hljs-number">0</span>) <span class="hljs-keyword">and</span> (<span class="hljs-keyword">not</span> player.walking_state.walking) <span class="hljs-keyword">then</span>
                player.character_running_speed_modifier = <span class="hljs-number">0</span>
            <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>
    )
<span class="hljs-keyword">end</span></code></pre>
<p>Even with the extra boilerplate generated, the code is still quite readable. Could be cleaner! Surely as the TypeScriptToLua compiler evolves in time, it will be.</p>
<h2>Deploy it</h2>
<p>I do not yet have clean, polished package &#x26; deploy scripts, but I do have functional ones.
Do your best to cover your eyes. Running <code>yarn install_mod</code> syncs the mod into the local Factorio installation. Coupled with a watch script, every code change immediately syncs in the game folder, and requires only a scenario reload to exercise the new scripts.</p>
<pre><code class="language-json">"scripts": {
  "clean:install": "rm -rf ~/Library/Application\\ Support/factorio/mods/vroom*",
  "copy:install": "VERSION=$(cat info.json | jq -r .version) &#x26;&#x26; rsync -r --exclude node_modules --exclude '.git*' --exclude build --exclude 'npm*' --exclude README.md --exclude package.json --exclude '*.lock'  ./ ~/Library/Application\\ Support/factorio/mods/vroom_$VERSION/",
  "install_mod": "run-s clean:install copy:install",
  "watch": "chokidar 'locale/**/*.cfg' '**/*.lua' '**/*.json' -c 'yarn install_mod'"
}
</code></pre>
<p>Feel free to open an issue and collab on tidying the above in <a href="https://github.com/cdaringe/create-factorio-mod/">create-factorio-mod</a>. With very little work, surely some cross-platform tooling could make the bundling and syncing nice for community, even for those not using <code>factorio-type-kit</code>.</p>
<h2>Enjoy it</h2>
<p>The most important part of modding. Have fun playing:</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/5cfHPHv6jS0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</div></div></article></div></main></div><footer class="bg-accent-1 border-t border-accent-2"><div class="container mx-auto px-5"><div class="py-28 flex flex-col lg:flex-row items-center"><h3 class="text-4xl lg:text-5xl font-bold tracking-tighter leading-tight text-center lg:text-left mb-10 lg:mb-0 lg:pr-4 lg:w-1/2">‚öôÔ∏è ‚ò†Ô∏è üì°</h3></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Get started modding Factorio in TypeScript","date":"2021-01-24T05:35:07.322Z","slug":"get-started","author":{"name":"cdaringe","picture":"/factorio-type-kit/assets/blog/authors/cdaringe.jpeg"},"content":"\u003cp\u003e\u003cstrong\u003eOf course\u003c/strong\u003e we want type safety when programming Factorio mods. Unfortunately, Factorio's Lua modding API offers no such provisions. Good news! \u003ca href=\"https://github.com/cdaringe/factorio-type-kit\"\u003efactorio-type-kit\u003c/a\u003e helps bridge that gap via TypeScript. While TypeScript doesn't offer\nthe strongest safety guarantees of any language under the sun, it does offer moderate safety, and works well\nas a Lua replacement. The following steps are required to author factorio mods in TS:\u003c/p\u003e\n\u003ch2\u003eFactorio in TypeScript - Outline\u003c/h2\u003e\n\u003cp\u003eWe will execute the following steps later, but at a glance, here are the general required steps:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eInstall \u003ca href=\"https://nodejs.org/\"\u003enode\u003c/a\u003e. I recommend using \u003ca href=\"https://github.com/Schniz/fnm#using-a-script-macoslinux\"\u003efnm\u003c/a\u003e for installing and managing nodejs installations.\u003c/li\u003e\n\u003cli\u003e(optional) Install \u003ca href=\"https://classic.yarnpkg.com/en/docs/install\"\u003eyarn\u003c/a\u003e. \u003ccode\u003enpm\u003c/code\u003e is the default package manager for nodejs, but the following document uses \u003ccode\u003eyarn\u003c/code\u003e. It takes only moments to install.\u003c/li\u003e\n\u003cli\u003eSetup a \u003ccode\u003enodejs\u003c/code\u003e project\u003c/li\u003e\n\u003cli\u003eInstall \u003ca href=\"https://github.com/cdaringe/factorio-type-kit\"\u003efactorio-type-kit\u003c/a\u003e, \u003ca href=\"https://www.typescriptlang.org/#installation\"\u003etypescript\u003c/a\u003e, and \u003ca href=\"https://github.com/TypeScriptToLua/TypeScriptToLua\"\u003eTypeScriptToLua\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eConfigure the typescript compiler to use TypeScriptToLua\u003c/li\u003e\n\u003cli\u003eCode\u003c/li\u003e\n\u003cli\u003ePackage \u0026#x26; deploy the mod\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eIt is assumed that the reader has installed node \u0026#x26; yarn before proceeding further.\u003c/p\u003e\n\u003cp\u003eLet's get to work.\u003c/p\u003e\n\u003ch2\u003eBootstrapping a barebones mod\u003c/h2\u003e\n\u003cp\u003eThe following command can be run to bootstrap a fresh mod project \u003cem\u003eautomatically\u003c/em\u003e:\u003c/p\u003e\n\u003c!-- \u003cShell children='$ yarn create factorio-mod \u003cmod-name\u003e' /\u003e --\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-shell\"\u003e\u003cspan class=\"hljs-meta\"\u003e$\u003c/span\u003e\u003cspan class=\"bash\"\u003e yarn create factorio-mod \u0026#x3C;mod-name\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eFor demonstration purposes, I will create a mod called \u003ccode\u003evroom\u003c/code\u003e. This mod will make the character accelerate as he runs, allowing the player to travel at warp speed!\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-shell\"\u003e\u003cspan class=\"hljs-meta\"\u003e$\u003c/span\u003e\u003cspan class=\"bash\"\u003e yarn create factorio-mod vroom\u003c/span\u003e\n...\nVictory! Your mod is ready to roll. Execute the following commands to get going:\n  - cd \"/Users/cdaringe/src/vroom\"\n  - yarn start\n‚ú®  Done in 5.75s.\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis step automatically installs the aforementioned dependencies and sets up the compiler toolchain.\nIf you want to do these steps manually, please see the \u003ca href=\"https://github.com/cdaringe/vroom\"\u003evroom\u003c/a\u003e codebase, and replicate the artifacts hosted there. \u003ca href=\"https://mods.factorio.com/mod/vroom\"\u003e@mods.factorio.com\u003c/a\u003e\u003c/p\u003e\n\u003ch2\u003eUnderstanding the barebones mod\u003c/h2\u003e\n\u003cp\u003eLet us \u003ccode\u003ecd \"path/to/vroom\"\u003c/code\u003e, and study the content. If you\nare familiar with the \u003ca href=\"https://wiki.factorio.com/Tutorial:Mod_structure\"\u003efactorio mod directory stucture\u003c/a\u003e,\nthis should look quite familiar.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-shell\"\u003e~/src/vroom via ‚¨¢ v15.0.1\n‚ùØ ls -alh\nPermissions Size User     Date Modified Name\n.rw-r--r--   167 cdaringe 24 Jan 11:37  control.ts\n.rw-r--r--   183 cdaringe 24 Jan 11:37  info.json\ndrwxr-xr-x     - cdaringe 24 Jan 11:37  node_modules\n.rw-r--r--   247 cdaringe 24 Jan 11:37  package.json\n.rw-r--r--   131 cdaringe 24 Jan 11:37  readme.md\n.rw-r--r--   331 cdaringe 24 Jan 11:37  tsconfig.json\n.rw-r--r--   35k cdaringe 24 Jan 11:37  yarn.lock\u003c/code\u003e\u003c/pre\u003e\n \u003c!-- `.trim()} /\u003e --\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003einfo.json\u003c/code\u003e - the entrypont to all factorio mods, pre-populated with some essentials\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003econtrol.ts\u003c/code\u003e - this file will compile to \u003ccode\u003econtrol.lua\u003c/code\u003e, which Factorio uses to run your mod!\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003etsconfig.json\u003c/code\u003e - typescript configuration, critically including \u003ca href=\"https://typescripttolua.github.io/docs/configuration\"\u003eTypescriptToLua configuration\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003epackage.json\u003c/code\u003e \u0026#x26; \u003ccode\u003enode_modules\u003c/code\u003e - resources to support your TS development experience :)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eLet's open up \u003ccode\u003econtrol.ts\u003c/code\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e onTick = \u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003e_evt: OnTickPayload\u003c/span\u003e) =\u003e\u003c/span\u003e {\n  game.print(serpent.block({\n    \u003cspan class=\"hljs-attr\"\u003ehello\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"world\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-attr\"\u003eits_nice\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"to see you\"\u003c/span\u003e\n  }));\n};\n\nscript.on_event(defines.events.on_tick, onTick);\u003c/code\u003e\u003c/pre\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003escript.on_event\u003c/code\u003e - typed\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003egame\u003c/code\u003e - typed\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eserpent\u003c/code\u003e - typed\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eevt\u003c/code\u003e - typed, via casting\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eBoom! Types for everything!\u003c/p\u003e\n\u003cp\u003e...but not quite. The Factorio Lua documentation is \u003cem\u003elossy\u003c/em\u003e, and has many cases where we simply \u003cem\u003ecannot\u003c/em\u003e parse correct type definitions from the Factorio website. Until the factorio development team publicly supports  machine-readable API documentation, \u003ccode\u003efactorio-type-kit\u003c/code\u003e TypeScript provisions will generally only be 70-80%+ complete. Thus, TypeScript users will be periodically disappointed to find \u003ccode\u003eany\u003c/code\u003e or \u003ccode\u003eunknown\u003c/code\u003e types in various interfaces. With that said, \u003ccode\u003efactorio-type-kit\u003c/code\u003e users are welcome to manually backfill essential definitions to make our community's development kit better.\u003c/p\u003e\n\u003ch2\u003eStarting the mod compiler\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-shell\"\u003e\u003cspan class=\"hljs-meta\"\u003e$\u003c/span\u003e\u003cspan class=\"bash\"\u003e yarn start\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eMomentarily after launching the watching compiler, \u003ccode\u003econtrol.lua\u003c/code\u003e should be emitted. Open it up:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-lua\"\u003eonTick = \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(_evt)\u003c/span\u003e\u003c/span\u003e\n    game.\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(\n        serpent.block({hello = \u003cspan class=\"hljs-string\"\u003e\"world\"\u003c/span\u003e, its_nice = \u003cspan class=\"hljs-string\"\u003e\"to see you\"\u003c/span\u003e})\n    )\n\u003cspan class=\"hljs-keyword\"\u003eend\u003c/span\u003e\nscript.on_event(defines.events.on_tick, onTick)\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe TypeScriptToLua compiler does a fanstastic job on producing readable Lua.\u003c/p\u003e\n\u003ch2\u003eImplementing vroom\u003c/h2\u003e\n\u003cp\u003eThe very first thing the \u003ccode\u003evroom\u003c/code\u003e mod needs to do is detect when the player is in motion.\u003c/p\u003e\n\u003cp\u003eRather that pull up the documentation, I'll just open up another call \u003ccode\u003escript.on_event\u003c/code\u003e, then\nbegin typing in \u003ccode\u003edefines.events.\u003c/code\u003e. After intellisense presents me options, I will select \u003ccode\u003eon_player_changed_position\u003c/code\u003e. The type definitions tell me a callback is also required. I will enter in \u003ccode\u003eonPositionChanged\u003c/code\u003e.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003escript.on_event(\n  defines.events.on_player_changed_position,\n  onPositionChange\n);\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003eonPositionChange\u003c/code\u003e is not defined yet. Let's discuss what it needs to do then draft it.\nFirst, it needs to get the player's current speed. Next, the speed needs to increase when running. Because the purpose of the mod is to accelerate the user, we multiply the previous speed by a scalar every so often.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e onPositionChange = \u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003eevt: OnPlayerChangedPositionPayload\u003c/span\u003e) =\u003e\u003c/span\u003e {\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e player = game.get_player(evt.player_index);\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (player.walking_state.walking) {\n    \u003cspan class=\"hljs-comment\"\u003e// ...\u003c/span\u003e\n  }\n};\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eImmediately take note that we have manually specified the type of \u003ccode\u003eevt\u003c/code\u003e as \u003ccode\u003eOnPlayerChangedPositionPayload\u003c/code\u003e. All factorio script event types follow the event naming convention: \u003ccode\u003e\u0026#x3C;CamelCased-EventName\u003ePayload\u003c/code\u003e. A future version may automatically apply types to the \u003ccode\u003eon_event\u003c/code\u003e callback, so you not need cast.\u003c/p\u003e\n\u003cp\u003eThe first thing I noticed was that \u003ccode\u003eevt\u003c/code\u003e did not have a reference directly to the player I needed.\nIt does contain the \u003ccode\u003eplayer_id\u003c/code\u003e however, and with that ID we can call the \u003ccode\u003eget_player\u003c/code\u003e method on the global \u003ccode\u003egame\u003c/code\u003e instance. \u003ccode\u003eget_player\u003c/code\u003e returns an instance of a \u003ccode\u003eLuaPlayer\u003c/code\u003e, contains a \u003ccode\u003ewalking_state\u003c/code\u003e property. Let's use \u003cem\u003ethat\u003c/em\u003e. We know that we \u003cem\u003eonly\u003c/em\u003e want to speed up the player if he is in motion, so let's further wrap our logic inside a conditional--\u003ccode\u003eif (player.walking_state.walking) { ... }\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eNext up, how do we actually speed up the player? After searching the API documentation, I concluded that there was not a direct value specifying a velocity of the character. However, I did come across \u003ccode\u003echaracter_running_speed_modifier\u003c/code\u003e, which the type definitions told me is of type \u003ccode\u003enumber\u003c/code\u003e. Unexpectedly, through trial and error, I learned that \u003ccode\u003echaracter_running_speed_modifier\u003c/code\u003e could be zero. \u003ccode\u003eSpeed * 0 = 0\u003c/code\u003e, so Factorio likely does a 0 check internally before calculating the player's speed. We will have to do a similar check. Notice that typescript did not me help uncover my bug! Anything of type \u003ccode\u003enumber\u003c/code\u003e can rightfully be zero, so shame on me! Defensive programmers everywhere are saying \"you should have seen this coming\", and they would be correct :). Equipped with this knowledge, let's fill in the rest.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e onPositionChange = \u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003eevt: OnPlayerChangedPositionPayload\u003c/span\u003e) =\u003e\u003c/span\u003e {\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e player = game.get_player(evt.player_index);\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (player.walking_state.walking) {\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e lastSpeed = player.character_running_speed_modifier;\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e baseSpeed = lastSpeed == \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e ? \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e : lastSpeed;\n    player.character_running_speed_modifier = baseSpeed * \u003cspan class=\"hljs-number\"\u003e1.01\u003c/span\u003e;\n  }\n};\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWhen our player stops running, we want to restart the acceleration process for the next time he runs.\nMy original approach was to listen for \u003ccode\u003ekeyup\u003c/code\u003e events. Alas, Factorio has no key events. How else could I determine if the player has stopped running, and thus safely reset the speed modifier? Easy! On every tick of the game, I can check all players for motion--and turn off the multiplier if they are stopped!\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e onTick = \u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003e_evt: OnTickPayload\u003c/span\u003e) =\u003e\u003c/span\u003e {\n  \u003cspan class=\"hljs-built_in\"\u003eObject\u003c/span\u003e.entries(game.players).forEach(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003e[_id, player]\u003c/span\u003e) =\u003e\u003c/span\u003e {\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\n      player.character_running_speed_modifier \u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e \u0026#x26;\u0026#x26;\n      !player.walking_state.walking\n    ) {\n      player.character_running_speed_modifier = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e;\n    }\n  });\n};\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThat is, for every player, if there is a positive speed modifier and and the player is not walking, zero out the modifier.\u003c/p\u003e\n\u003cp\u003eWhy didn't we just do a \u003ccode\u003egame.players.forEach\u003c/code\u003e? \u003ccode\u003egame.players\u003c/code\u003e isn't an array, so that won't work. TypeScript protected us from making that mistake! What about \u003ccode\u003eObject.entries(game.players).forEach\u003c/code\u003e? Yep, that worked! Why did we not do \u003ccode\u003eObject.values(...)\u003c/code\u003e? Because \u003ccode\u003egame.players\u003c/code\u003e is a \u003ca href=\"https://lua-api.factorio.com/latest/LuaGameScript.html#LuaGameScript.players\"\u003especial dictionary\u003c/a\u003e in Lua. Not all iterables map cleanly between languages. \u003ccode\u003eObject.values(...)\u003c/code\u003e wouldn't have given us compiler error, but still would have failed. Improved typing is needed to protect against these failures. While TypeScriptToLua generally helps out a great deal protect us from writing erroneous code, it is only as good as its applied type constraints.\u003c/p\u003e\n\u003cp\u003eWhen using JS standard library provisions, as we did above, the compiler will add a typescript-lua polyfill, \u003ccode\u003elualib_bundle\u003c/code\u003e. The emitted Lua perhaps is not as elegant:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-lua\"\u003e\u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"lualib_bundle\"\u003c/span\u003e);\n\u003cspan class=\"hljs-comment\"\u003e-- ...\u003c/span\u003e\nonTick = \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(_evt)\u003c/span\u003e\u003c/span\u003e\n    __TS__ArrayForEach(\n        __TS__ObjectEntries(game.players),\n        \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(____, ____bindingPattern0)\u003c/span\u003e\u003c/span\u003e\n            \u003cspan class=\"hljs-keyword\"\u003elocal\u003c/span\u003e _id = ____bindingPattern0[\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e]\n            \u003cspan class=\"hljs-keyword\"\u003elocal\u003c/span\u003e player\n            player = ____bindingPattern0[\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e]\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (player.character_running_speed_modifier \u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003eand\u003c/span\u003e (\u003cspan class=\"hljs-keyword\"\u003enot\u003c/span\u003e player.walking_state.walking) \u003cspan class=\"hljs-keyword\"\u003ethen\u003c/span\u003e\n                player.character_running_speed_modifier = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\n            \u003cspan class=\"hljs-keyword\"\u003eend\u003c/span\u003e\n        \u003cspan class=\"hljs-keyword\"\u003eend\u003c/span\u003e\n    )\n\u003cspan class=\"hljs-keyword\"\u003eend\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eEven with the extra boilerplate generated, the code is still quite readable. Could be cleaner! Surely as the TypeScriptToLua compiler evolves in time, it will be.\u003c/p\u003e\n\u003ch2\u003eDeploy it\u003c/h2\u003e\n\u003cp\u003eI do not yet have clean, polished package \u0026#x26; deploy scripts, but I do have functional ones.\nDo your best to cover your eyes. Running \u003ccode\u003eyarn install_mod\u003c/code\u003e syncs the mod into the local Factorio installation. Coupled with a watch script, every code change immediately syncs in the game folder, and requires only a scenario reload to exercise the new scripts.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-json\"\u003e\"scripts\": {\n  \"clean:install\": \"rm -rf ~/Library/Application\\\\ Support/factorio/mods/vroom*\",\n  \"copy:install\": \"VERSION=$(cat info.json | jq -r .version) \u0026#x26;\u0026#x26; rsync -r --exclude node_modules --exclude '.git*' --exclude build --exclude 'npm*' --exclude README.md --exclude package.json --exclude '*.lock'  ./ ~/Library/Application\\\\ Support/factorio/mods/vroom_$VERSION/\",\n  \"install_mod\": \"run-s clean:install copy:install\",\n  \"watch\": \"chokidar 'locale/**/*.cfg' '**/*.lua' '**/*.json' -c 'yarn install_mod'\"\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eFeel free to open an issue and collab on tidying the above in \u003ca href=\"https://github.com/cdaringe/create-factorio-mod/\"\u003ecreate-factorio-mod\u003c/a\u003e. With very little work, surely some cross-platform tooling could make the bundling and syncing nice for community, even for those not using \u003ccode\u003efactorio-type-kit\u003c/code\u003e.\u003c/p\u003e\n\u003ch2\u003eEnjoy it\u003c/h2\u003e\n\u003cp\u003eThe most important part of modding. Have fun playing:\u003c/p\u003e\n\u003ciframe width=\"560\" height=\"315\" src=\"https://www.youtube.com/embed/5cfHPHv6jS0\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen\u003e\u003c/iframe\u003e\n"}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"get-started"},"buildId":"T1qVaFXq3czWLJYG2pbJ3","assetPrefix":"/factorio-type-kit","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/factorio-type-kit/_next/static/chunks/polyfills-99d808df29361cf7ffb1.js"></script><script src="/factorio-type-kit/_next/static/chunks/main-ae4733327bd95c4ac325.js" async=""></script><script src="/factorio-type-kit/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" async=""></script><script src="/factorio-type-kit/_next/static/chunks/framework.9d524150d48315f49e80.js" async=""></script><script src="/factorio-type-kit/_next/static/chunks/commons.9852770279c0c14d4cef.js" async=""></script><script src="/factorio-type-kit/_next/static/chunks/pages/_app-3b43a8403cdc10895abd.js" async=""></script><script src="/factorio-type-kit/_next/static/chunks/2c3b9bffc7150b37a7b3810dfcf1c0b0fac2bd18.c4172b38757f6e9df0dd.js" async=""></script><script src="/factorio-type-kit/_next/static/chunks/pages/posts/%5Bslug%5D-a955a00b7703730922ad.js" async=""></script><script src="/factorio-type-kit/_next/static/T1qVaFXq3czWLJYG2pbJ3/_buildManifest.js" async=""></script><script src="/factorio-type-kit/_next/static/T1qVaFXq3czWLJYG2pbJ3/_ssgManifest.js" async=""></script><link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@10.5.0/styles/monokai.min.css"/></body></html>