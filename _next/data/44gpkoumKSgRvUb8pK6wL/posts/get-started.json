{"pageProps":{"post":{"title":"Get started modding Factorio in TypeScript","date":"2021-01-24T05:35:07.322Z","slug":"get-started","author":{"name":"cdaringe","picture":"/factorio-type-kit/assets/blog/authors/cdaringe.jpeg"},"content":"<p><strong>Of course</strong> we want type safety when programming Factorio mods. Unfortunately, Factorio's Lua modding API offers no such provisions. Good news! <a href=\"https://github.com/cdaringe/factorio-type-kit\">factorio-type-kit</a> helps bridge that gap via TypeScript. While TypeScript doesn't offer\nthe strongest safety guarantees of any language under the sun, it does offer moderate safety, and works well\nas a Lua replacement. The following steps are required to author factorio mods in TS:</p>\n<h2>Factorio in TypeScript - Outline</h2>\n<p>We will execute the following steps later, but at a glance, here are the general required steps:</p>\n<ol>\n<li>Install <a href=\"https://nodejs.org/\">node</a>. I recommend using <a href=\"https://github.com/Schniz/fnm#using-a-script-macoslinux\">fnm</a> for installing and managing nodejs installations.</li>\n<li>(optional) Install <a href=\"https://classic.yarnpkg.com/en/docs/install\">yarn</a>. <code>npm</code> is the default package manager for nodejs, but the following document uses <code>yarn</code>. It takes only moments to install.</li>\n<li>Setup a <code>nodejs</code> project</li>\n<li>Install <a href=\"https://github.com/cdaringe/factorio-type-kit\">factorio-type-kit</a>, <a href=\"https://www.typescriptlang.org/#installation\">typescript</a>, and <a href=\"https://github.com/TypeScriptToLua/TypeScriptToLua\">TypeScriptToLua</a></li>\n<li>Configure the typescript compiler to use TypeScriptToLua</li>\n<li>Code</li>\n<li>Package &#x26; deploy the mod</li>\n</ol>\n<p>It is assumed that the reader has installed node &#x26; yarn before proceeding further.</p>\n<p>Let's get to work.</p>\n<h2>Bootstrapping a barebones mod</h2>\n<p>The following command can be run to bootstrap a fresh mod project <em>automatically</em>:</p>\n<!-- <Shell children='$ yarn create factorio-mod <mod-name>' /> -->\n<pre><code class=\"hljs language-shell\"><span class=\"hljs-meta\">$</span><span class=\"bash\"> yarn create factorio-mod &#x3C;mod-name></span></code></pre>\n<p>For demonstration purposes, I will create a mod called <code>vroom</code>. This mod will make the character accelerate as he runs, allowing the player to travel at warp speed!</p>\n<pre><code class=\"hljs language-shell\"><span class=\"hljs-meta\">$</span><span class=\"bash\"> yarn create factorio-mod vroom</span>\n...\nVictory! Your mod is ready to roll. Execute the following commands to get going:\n  - cd \"/Users/cdaringe/src/vroom\"\n  - yarn start\n✨  Done in 5.75s.</code></pre>\n<p>This step automatically installs the aforementioned dependencies and sets up the compiler toolchain.\nIf you want to do these steps manually, please see the <a href=\"https://github.com/cdaringe/vroom\">vroom</a> codebase, and replicate the artifacts hosted there. <a href=\"https://mods.factorio.com/mod/vroom\">@mods.factorio.com</a></p>\n<h2>Understanding the barebones mod</h2>\n<p>Let us <code>cd \"path/to/vroom\"</code>, and study the content. If you\nare familiar with the <a href=\"https://wiki.factorio.com/Tutorial:Mod_structure\">factorio mod directory stucture</a>,\nthis should look quite familiar.</p>\n<pre><code class=\"hljs language-shell\">~/src/vroom via ⬢ v15.0.1\n❯ ls -alh\nPermissions Size User     Date Modified Name\n.rw-r--r--   167 cdaringe 24 Jan 11:37  control.ts\n.rw-r--r--   183 cdaringe 24 Jan 11:37  info.json\ndrwxr-xr-x     - cdaringe 24 Jan 11:37  node_modules\n.rw-r--r--   247 cdaringe 24 Jan 11:37  package.json\n.rw-r--r--   131 cdaringe 24 Jan 11:37  readme.md\n.rw-r--r--   331 cdaringe 24 Jan 11:37  tsconfig.json\n.rw-r--r--   35k cdaringe 24 Jan 11:37  yarn.lock</code></pre>\n <!-- `.trim()} /> -->\n<ul>\n<li><code>info.json</code> - the entrypont to all factorio mods, pre-populated with some essentials</li>\n<li><code>control.ts</code> - this file will compile to <code>control.lua</code>, which Factorio uses to run your mod!</li>\n<li><code>tsconfig.json</code> - typescript configuration, critically including <a href=\"https://typescripttolua.github.io/docs/configuration\">TypescriptToLua configuration</a></li>\n<li><code>package.json</code> &#x26; <code>node_modules</code> - resources to support your TS development experience :)</li>\n</ul>\n<p>Let's open up <code>control.ts</code>:</p>\n<pre><code class=\"hljs language-typescript\"><span class=\"hljs-keyword\">const</span> onTick = <span class=\"hljs-function\">(<span class=\"hljs-params\">_evt: OnTickPayload</span>) =></span> {\n  game.print(serpent.block({\n    <span class=\"hljs-attr\">hello</span>: <span class=\"hljs-string\">\"world\"</span>,\n    <span class=\"hljs-attr\">its_nice</span>: <span class=\"hljs-string\">\"to see you\"</span>\n  }));\n};\n\nscript.on_event(defines.events.on_tick, onTick);</code></pre>\n<ul>\n<li><code>script.on_event</code> - typed</li>\n<li><code>game</code> - typed</li>\n<li><code>serpent</code> - typed</li>\n<li><code>evt</code> - typed, via casting</li>\n</ul>\n<p>Boom! Types for everything!</p>\n<p>...but not quite. The Factorio Lua documentation is <em>lossy</em>, and has many cases where we simply <em>cannot</em> parse correct type definitions from the Factorio website. Until the factorio development team publicly supports  machine-readable API documentation, <code>factorio-type-kit</code> TypeScript provisions will generally only be 70-80%+ complete. Thus, TypeScript users will be periodically disappointed to find <code>any</code> or <code>unknown</code> types in various interfaces. With that said, <code>factorio-type-kit</code> users are welcome to manually backfill essential definitions to make our community's development kit better.</p>\n<h2>Starting the mod compiler</h2>\n<pre><code class=\"hljs language-shell\"><span class=\"hljs-meta\">$</span><span class=\"bash\"> yarn start</span></code></pre>\n<p>Momentarily after launching the watching compiler, <code>control.lua</code> should be emitted. Open it up:</p>\n<pre><code class=\"hljs language-lua\">onTick = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span><span class=\"hljs-params\">(_evt)</span></span>\n    game.<span class=\"hljs-built_in\">print</span>(\n        serpent.block({hello = <span class=\"hljs-string\">\"world\"</span>, its_nice = <span class=\"hljs-string\">\"to see you\"</span>})\n    )\n<span class=\"hljs-keyword\">end</span>\nscript.on_event(defines.events.on_tick, onTick)</code></pre>\n<p>The TypeScriptToLua compiler does a fanstastic job on producing readable Lua.</p>\n<h2>Implementing vroom</h2>\n<p>The very first thing the <code>vroom</code> mod needs to do is detect when the player is in motion.</p>\n<p>Rather that pull up the documentation, I'll just open up another call <code>script.on_event</code>, then\nbegin typing in <code>defines.events.</code>. After intellisense presents me options, I will select <code>on_player_changed_position</code>. The type definitions tell me a callback is also required. I will enter in <code>onPositionChanged</code>.</p>\n<pre><code class=\"hljs language-typescript\">script.on_event(\n  defines.events.on_player_changed_position,\n  onPositionChange\n);</code></pre>\n<p><code>onPositionChange</code> is not defined yet. Let's discuss what it needs to do then draft it.\nFirst, it needs to get the player's current speed. Next, the speed needs to increase when running. Because the purpose of the mod is to accelerate the user, we multiply the previous speed by a scalar every so often.</p>\n<pre><code class=\"hljs language-typescript\"><span class=\"hljs-keyword\">const</span> onPositionChange = <span class=\"hljs-function\">(<span class=\"hljs-params\">evt: OnPlayerChangedPositionPayload</span>) =></span> {\n  <span class=\"hljs-keyword\">const</span> player = game.get_player(evt.player_index);\n  <span class=\"hljs-keyword\">if</span> (player.walking_state.walking) {\n    <span class=\"hljs-comment\">// ...</span>\n  }\n};</code></pre>\n<p>Immediately take note that we have manually specified the type of <code>evt</code> as <code>OnPlayerChangedPositionPayload</code>. All factorio script event types follow the event naming convention: <code>&#x3C;CamelCased-EventName>Payload</code>. A future version may automatically apply types to the <code>on_event</code> callback, so you not need cast.</p>\n<p>The first thing I noticed was that <code>evt</code> did not have a reference directly to the player I needed.\nIt does contain the <code>player_id</code> however, and with that ID we can call the <code>get_player</code> method on the global <code>game</code> instance. <code>get_player</code> returns an instance of a <code>LuaPlayer</code>, contains a <code>walking_state</code> property. Let's use <em>that</em>. We know that we <em>only</em> want to speed up the player if he is in motion, so let's further wrap our logic inside a conditional--<code>if (player.walking_state.walking) { ... }</code>.</p>\n<p>Next up, how do we actually speed up the player? After searching the API documentation, I concluded that there was not a direct value specifying a velocity of the character. However, I did come across <code>character_running_speed_modifier</code>, which the type definitions told me is of type <code>number</code>. Unexpectedly, through trial and error, I learned that <code>character_running_speed_modifier</code> could be zero. <code>Speed * 0 = 0</code>, so Factorio likely does a 0 check internally before calculating the player's speed. We will have to do a similar check. Notice that typescript did not me help uncover my bug! Anything of type <code>number</code> can rightfully be zero, so shame on me! Defensive programmers everywhere are saying \"you should have seen this coming\", and they would be correct :). Equipped with this knowledge, let's fill in the rest.</p>\n<pre><code class=\"hljs language-typescript\"><span class=\"hljs-keyword\">const</span> onPositionChange = <span class=\"hljs-function\">(<span class=\"hljs-params\">evt: OnPlayerChangedPositionPayload</span>) =></span> {\n  <span class=\"hljs-keyword\">const</span> player = game.get_player(evt.player_index);\n  <span class=\"hljs-keyword\">if</span> (player.walking_state.walking) {\n    <span class=\"hljs-keyword\">const</span> lastSpeed = player.character_running_speed_modifier;\n    <span class=\"hljs-keyword\">const</span> baseSpeed = lastSpeed == <span class=\"hljs-number\">0</span> ? <span class=\"hljs-number\">1</span> : lastSpeed;\n    player.character_running_speed_modifier = baseSpeed * <span class=\"hljs-number\">1.01</span>;\n  }\n};</code></pre>\n<p>When our player stops running, we want to restart the acceleration process for the next time he runs.\nMy original approach was to listen for <code>keyup</code> events. Alas, Factorio has no key events. How else could I determine if the player has stopped running, and thus safely reset the speed modifier? Easy! On every tick of the game, I can check all players for motion--and turn off the multiplier if they are stopped!</p>\n<pre><code class=\"hljs language-typescript\"><span class=\"hljs-keyword\">const</span> onTick = <span class=\"hljs-function\">(<span class=\"hljs-params\">_evt: OnTickPayload</span>) =></span> {\n  <span class=\"hljs-built_in\">Object</span>.entries(game.players).forEach(<span class=\"hljs-function\">(<span class=\"hljs-params\">[_id, player]</span>) =></span> {\n    <span class=\"hljs-keyword\">if</span> (\n      player.character_running_speed_modifier > <span class=\"hljs-number\">0</span> &#x26;&#x26;\n      !player.walking_state.walking\n    ) {\n      player.character_running_speed_modifier = <span class=\"hljs-number\">0</span>;\n    }\n  });\n};</code></pre>\n<p>That is, for every player, if there is a positive speed modifier and and the player is not walking, zero out the modifier.</p>\n<p>Why didn't we just do a <code>game.players.forEach</code>? <code>game.players</code> isn't an array, so that won't work. TypeScript protected us from making that mistake! What about <code>Object.entries(game.players).forEach</code>? Yep, that worked! Why did we not do <code>Object.values(...)</code>? Because <code>game.players</code> is a <a href=\"https://lua-api.factorio.com/latest/LuaGameScript.html#LuaGameScript.players\">special dictionary</a> in Lua. Not all iterables map cleanly between languages. <code>Object.values(...)</code> wouldn't have given us compiler error, but still would have failed. Improved typing is needed to protect against these failures. While TypeScriptToLua generally helps out a great deal protect us from writing erroneous code, it is only as good as its applied type constraints.</p>\n<p>When using JS standard library provisions, as we did above, the compiler will add a typescript-lua polyfill, <code>lualib_bundle</code>. The emitted Lua perhaps is not as elegant:</p>\n<pre><code class=\"hljs language-lua\"><span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">\"lualib_bundle\"</span>);\n<span class=\"hljs-comment\">-- ...</span>\nonTick = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span><span class=\"hljs-params\">(_evt)</span></span>\n    __TS__ArrayForEach(\n        __TS__ObjectEntries(game.players),\n        <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span><span class=\"hljs-params\">(____, ____bindingPattern0)</span></span>\n            <span class=\"hljs-keyword\">local</span> _id = ____bindingPattern0[<span class=\"hljs-number\">1</span>]\n            <span class=\"hljs-keyword\">local</span> player\n            player = ____bindingPattern0[<span class=\"hljs-number\">2</span>]\n            <span class=\"hljs-keyword\">if</span> (player.character_running_speed_modifier > <span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">and</span> (<span class=\"hljs-keyword\">not</span> player.walking_state.walking) <span class=\"hljs-keyword\">then</span>\n                player.character_running_speed_modifier = <span class=\"hljs-number\">0</span>\n            <span class=\"hljs-keyword\">end</span>\n        <span class=\"hljs-keyword\">end</span>\n    )\n<span class=\"hljs-keyword\">end</span></code></pre>\n<p>Even with the extra boilerplate generated, the code is still quite readable. Could be cleaner! Surely as the TypeScriptToLua compiler evolves in time, it will be.</p>\n<h2>Deploy it</h2>\n<p>I do not yet have clean, polished package &#x26; deploy scripts, but I do have functional ones.\nDo your best to cover your eyes. Running <code>yarn install_mod</code> syncs the mod into the local Factorio installation. Coupled with a watch script, every code change immediately syncs in the game folder, and requires only a scenario reload to exercise the new scripts.</p>\n<pre><code class=\"language-json\">\"scripts\": {\n  \"clean:install\": \"rm -rf ~/Library/Application\\\\ Support/factorio/mods/vroom*\",\n  \"copy:install\": \"VERSION=$(cat info.json | jq -r .version) &#x26;&#x26; rsync -r --exclude node_modules --exclude '.git*' --exclude build --exclude 'npm*' --exclude README.md --exclude package.json --exclude '*.lock'  ./ ~/Library/Application\\\\ Support/factorio/mods/vroom_$VERSION/\",\n  \"install_mod\": \"run-s clean:install copy:install\",\n  \"watch\": \"chokidar 'locale/**/*.cfg' '**/*.lua' '**/*.json' -c 'yarn install_mod'\"\n}\n</code></pre>\n<p>Feel free to open an issue and collab on tidying the above in <a href=\"https://github.com/cdaringe/create-factorio-mod/\">create-factorio-mod</a>. With very little work, surely some cross-platform tooling could make the bundling and syncing nice for community, even for those not using <code>factorio-type-kit</code>.</p>\n<h2>Enjoy it</h2>\n<p>The most important part of modding. Have fun playing:</p>\n<iframe width=\"560\" height=\"315\" src=\"https://www.youtube.com/embed/5cfHPHv6jS0\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>\n"}},"__N_SSG":true}